#!/usr/bin/env zsh
#
# cleanup
# List all branches that have landed in master
# Fuzzy git delete local branchs and optionally
# delete the remote branch if it exists.
#-------------------------------------------------------------------------------

set -e

# ALLBRANCHES=$(gitbranches)
BRANCHES=()
checkmark="\033[0;32m\ue63f\033[0m"
# echo "hello"
# echo $ALLBRANCHES
# echo "bye"
# for branch in "${$(gitbranches)[@]}"; do
#   echo "foo - ${branch}"
# done
# BRANCH=$(gitbranches | fzf | trimleading) &&
# git branch -D ${BRANCH} &&
# delremote "${BRANCH}"

# git log --pretty='%C(auto)%h%Creset%C(auto)%d%Creset %s %Cgreen(%ar) %C(bold blue)<%an>%Creset'

# git log  --max-count=1

# git for-each-ref --shell \
#   --format='git log --oneline %(refname) ^origin/master' \
#   refs/heads/
# for branch in $(git for-each-ref --format='%(refname)' refs/heads/); do
#     git log $branch --max-count=1
# done

# eval "$(git for-each-ref --shell --format='BRANCHES+=(%(refname))' refs/heads/)"
# for branch in "${BRANCHES[@]}"; do
#     echo "$branch " $(git log $branch --max-count=1 | grep "Change-Id:")
# done

#-------------------------------------------------------------------------------
# Using github cli to find my prs that are closed
# Limit the results to 10 instead of the default 30
#
# ❯ gh pr list --state closed --author "@me" --search $(git rev-parse lgordon/janus-fix-spacing)
# Showing 1 of 1 pull request in ee/AppleSchoolManagerUI that matches your search
#
# ID      TITLE                                 BRANCH                     CREATED AT
# #16625  Fix Step content inheriting flex gap  lgordon/janus-fix-spacing  about 1 day ago
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# Using github cli to find my prs that are closed
# Limit the results to 10 instead of the default 30
#
# ❯ gh pr list --state merged --author "@me"
#
# ID      TITLE                                                                            BRANCH                                      CREATED AT
# #16625  Fix Step content inheriting flex gap                                             lgordon/janus-fix-spacing                   about 1 day ago
# #16601  Add block prop to Atomic Tabs component                                          lgordon/tabs-update                         about 8 days ago
# #16594  Fix broken Tabs styling and match APL design                                     lgordon/2420Beta                            about 9 days ago
# #16592  Fix broken Tabs styling and match APL design                                     lgordon/2420                                about 9 days ago
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# Using github cli to find my prs that are closed
# Limit the results to 10 instead of the default 30
#
# ❯ gh pr list --state merged --author "@me" --search "$(git rev-parse lgordon/janus-fix-spacing)"
# Showing 1 of 1 pull request in ee/AppleSchoolManagerUI that matches your search
#
# ID      TITLE                                 BRANCH                     CREATED AT
# #16625  Fix Step content inheriting flex gap  lgordon/janus-fix-spacing  about 1 day ago
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
# https://cli.github.com/manual/gh_pr_list
# ❯ gh pr list --state merged --author "@me" --search "4d1b560daddeb1a0cbc32efe4b08ae294f201d1"
# no pull requests match your search in ee/AppleSchoolManagerUI
#-------------------------------------------------------------------------------

# for branch in $(git for-each-ref refs/heads  | cut -d/ -f3-); do
echo hello
allBranches=( $(git for-each-ref refs/heads  | cut -d/ -f3-) );
targetBranch=$(git for-each-ref refs/heads  | cut -d/ -f3- | fzf | trimleading) &&
echo "- targetBranch $targetBranch"
for branch in $allBranches[@]; do
  echo "- loop: $branch"
  if [ "$branch" != $targetBranch ]; then
    # Get the commit hash from the last commit of a branch
    commitHash=$(git log --max-count=1 $branch | grep "commit" | cut -d" " -f2)
    echo "    - $branch commitHash $commitHash"
    # changeId=$(git log --max-count=1 $branch | grep "Change-Id:" | trimleading)
    # echo "    - changeId $changeId"
    if [ -n $commitHash ]; then
      echo "        - found commit hash: $commitHash"
      foundInTargetBranch=$(git log $targetBranch --grep "$commitHash")
      # echo "          - foundInTargetBranch: $foundInTargetBranch"
      if [ -n $foundInTargetBranch ]; then
        echo "            - found in $targetBranch"
        BRANCHES+=("$(echo "$checkmark ${branch}" | trimleading | trimtrailing)")
      else
        echo "            - |||| not found in $targetBranch"
        BRANCHES+=("$(echo "$branch" | trimleading | trimtrailing)")
      fi
    else
      echo "            - $$$$ commit hash not found"
      BRANCHES+=("$(echo "$branch" | trimleading | trimtrailing)")
    fi
  fi
done
echo "---------------------------------------"
for branch in $BRANCHES[@]; do
  echo $branch
done
echo "---------------------------------------"
# echo $BRANCHES | fzf --ansi -m

# echo '\ue63f' | chalk --stdin green
# echo "foo  bar"

# git log --grep="Change-Id: I91068b8edae0d9a915c0631d908111ed6ecd5a76" --pretty='%h%n%s%n%n%b'
# d36c3870af
# update observe-js.code-workspace gitlens remotes & remove deprecated setting

# * Remove `eslint.packageManager` because the setting is deprecated. The
# Package Manager is automatically detected now.
# * Update gitlens remotes for better urls when wanting to view a file in
# Gerrit

# Change-Id: I91068b8edae0d9a915c0631d908111ed6ecd5a76
