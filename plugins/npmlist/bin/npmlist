#!/usr/bin/env node
'use strict';

const exec = require('child_process').exec;
const fs = require('fs');
const path = require('path');
const regNewline = /\n|\r/;

let cmd = ['npm list --depth=0'];
let shouldProcess = false;
let savePath = path.resolve(process.env.HOME);
let filename = '.npmlist';

process.argv.slice(2).forEach(function (arg) {
  if (arg.indexOf('-') === 0) {
    if (arg.indexOf('g') !== -1) {
      cmd.push('-g');
      filename += '-g';
    }
    if (arg.indexOf('s') !== -1) {
      shouldProcess = true;
    }
  }
});

exec(cmd.join(' '), function (error, stdout) {
  if (error !== null) {
    console.log('exec error: ' + error);
  }
  var results = stdout
    .split(regNewline)
    .filter(function (line) {
      return line.length;
    });
  console.log(results.join('\n'));
  if (shouldProcess) processModules(results);
});

function processModules(data) {
  let results = data.map(function (line) {
    return line.replace(/^(\S{3}\s)(\S+?)(@\S+)/gim, '$2');
  }).filter(function (line, i) {
    return i !== 0 && line !== 'npm';
  });

  let installCmd = ['\nnpm install -g ' + results.join(' ')];
  let header = ['#!/usr/bin/env bash', '# ' + new Date(), '#'];
  results = header.concat(
    data.map(function (line) {
      return '# ' + line;
    }), installCmd)
  .join('\n');

  let file = path.join(savePath, filename);
  fs.writeFile(file, results, 'utf8', function (err) {
    if (err) throw err;
    console.log('\nnpm global list saved to:', file);
  });
}
