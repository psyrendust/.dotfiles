#!/usr/bin/env node

var exec = require('child_process').exec;
var fs = require('fs');
var path = require('path');
var regNewline = /\n|\r/;
var regLineReplace = /^(\S{3}\s)(\S+?)(@\S+)/gim;

var cmd = ['npm list --depth=0'];
var shouldProcess = false;
var savePath = path.resolve(process.env.HOME);
var filename = '.npmlist';

process.argv.slice(2).forEach(function (arg) {
  if (arg.indexOf('-') === 0) {
    if (arg.indexOf('g') !== -1) {
      cmd.push('-g');
      filename += '-g';
    }
    if (arg.indexOf('s') !== -1) {
      shouldProcess = true;
    }
  }
});

exec(cmd.join(' '), function (error, stdout) {
  if (error !== null) {
    console.log(`exec error: ${error}`);
  }
  var results = stdout
    .split(regNewline)
    .filter(function (line) {
      return line.length;
    });
  console.log(results.join('\n'));
  if (shouldProcess) processModules(results);
});

function processModules(data) {
  var results = data.map(function (line) {
    return line.replace(regLineReplace, '$2');
  }).filter(function (line, i) {
    return i !== 0 && line !== 'npm';
  });

  var installCmd = [`\nnpm install -g ${results.join(' ')}\n`];
  var header = ['#!/usr/bin/env bash', `# ${new Date()}`, '#'];
  results = header.concat(
    data.map(function (line) {
      return `# ${line}`;
    }), installCmd)
  .join('\n');

  var file = path.join(savePath, filename);
  fs.writeFile(file, results, 'utf8', function (err) {
    if (err) throw err;
    console.log(`\n${installCmd}\nnpm global list saved to: ${file}`);
  });
}
